<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>3D Gaussian Splat Viewer</title>
    <style>
      body {
        margin: 0;
      }

      .selectrobot_container {
        display: flex;
        flex-direction: column;
        position: relative;
        width: 100%;
        height: 100vh;
      }

      .selectrobot_title {
        text-align: center;
      }

      .selectrobot_robot1 {
        position: absolute;
        display: flex;
      }

      .selectrobot_robot2 {
        position: absolute;
        display: flex;
      }

      .selectrobot_robot_btn {
        z-index: 10;
        border-radius: 100px;
        width: 30px;
        height: 30px;
      }

      .selectrobot_robot_name {
        padding-left: 10px;
      }

      .selectrobot_check {
        text-align: center;
      }

      .selectrobot_check_btn {
        width: 300px;
        height: 80px;
        border-radius: 10px;
        font-size: large;
      }

      .selectrobot_map {
        position: relative;

        width: 100%;
      }

      #selectrobot_gaussian {
        width: 100%;
      }

      #selectrobot_gaussian {
        width: 100%;
      }

      .position_container,
      .select_container,
      .gaussian_map {
        padding-left: 40px;
        padding-right: 40px;
      }
    </style>
  </head>

  <body>
    <div id="header"></div>
    <div class="selectrobot_container">
      <div class="selectrobot_title">
        <h1 id="title">호출할 로봇을 선택해주세요</h1>
        <h3>빨간색으로 표시된 것은 사용 중인 로봇이니, 사용할 수 없습니다.</h3>
      </div>
      <div class="selectrobot_map" id="selectrobot_map">
        <img
          id="selectrobot_gaussian"
          alt="gaussian_img"
          src="assets/images/minimap_background.png"
        />
        <!-- 로봇 선택 버튼 -->
        <div class="selectrobot_robot1">
          <button
            class="selectrobot_robot_btn"
            ,
            type="button"
            ,
            onclick="updateTitle('1')"
          ></button>
          <div class="selectrobot_robot_name">로봇 1</div>
        </div>
        <div class="selectrobot_robot2">
          <button
            class="selectrobot_robot_btn"
            ,
            type="button"
            ,
            onclick="updateTitle('2')"
          ></button>
          <div class="selectrobot_robot_name">로봇 2</div>
        </div>

        <!-- 랜드마크 버튼 -->
        <!-- <div class="selectrobot_landmark">
          <button class="selectrobot_landmark_btn" , type="button"></button>
        </div> -->
      </div>

      <div class="selectrobot_check">
        <button
          class="selectrobot_check_btn"
          ,
          type="button"
          ,
          onclick="openDemo('minimap')"
        >
          선택 완료
        </button>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch("header.html")
          .then((response) => response.text())
          .then((data) => {
            document.getElementById("header").innerHTML = data;
          })
          .catch((error) => console.error("Error loading header:", error));
      });

      fetch("robotdata.json")
        .then((response) => response.json())
        .then((data) => {
          data.forEach((robot) => {
            const robotElement = document.querySelector(
              `.selectrobot_robot${robot.robotId}`
            );
            if (robotElement) {
              robotElement.style.top = robot.top;
              robotElement.style.left = robot.left;

              const button = robotElement.querySelector(
                ".selectrobot_robot_btn"
              );
              if (robot.available) {
                // 사용 가능한 경우
                button.style.backgroundColor = "green";
              } else {
                button.style.backgroundColor = "red";
              }

              button.onclick = () =>
                updateTitle(
                  robot.robotId,
                  robot.top,
                  robot.left,
                  robot.available
                );
            }
          });
        });

      const selectrobot = document.getElementById("selectrobot_map");
      const background = document.getElementById("selectrobot_gaussian");
      const markerCurrent = document.getElementById("marker_current");
      let markerDestination = null; // destination 마커를 관리하는 변수
      let selectedRobot = null;
      let selectedAvailable = null;

      function updateTitle(robotName, top, left, available) {
        const title = document.getElementById("title");
        title.textContent = `호출할 로봇을 선택해주세요 (로봇 ${robotName})`;
        selectedRobot = robotName;
        selectedAvailable = available;

        console.log(`${selectedAvailable}`);

        const robotElement = document.querySelector(
          `.selectrobot_robot${robotName}`
        );
        const parentElement = document.getElementById("selectrobot_map");

        // 로봇 좌표 퍼센트 구하기
        if (robotElement && parentElement) {
          // 부모 요소(미니맵 이미지)의 크기 구하기
          const parentWidth = parentElement.offsetWidth;
          const parentHeight = parentElement.offsetHeight;

          // 로봇 위치 계산 (픽셀 -> 퍼센트)
          const rect = robotElement.getBoundingClientRect();

          // 부모 요소의 크기와 페이지 스크롤 위치를 고려하여 상대 위치 계산
          const topPercentage =
            ((rect.top - parentElement.getBoundingClientRect().top) /
              parentHeight) *
            100;
          const leftPercentage =
            ((rect.left - parentElement.getBoundingClientRect().left) /
              parentWidth) *
            100;

          selectedTop = `${topPercentage}%`;
          selectedLeft = `${leftPercentage}%`;

          console.log(`${robotName}, ${selectedTop}, ${selectedLeft}`);
        }
      }

      function openHome(page) {
        let url = page + ".html";
        window.location = url;
      }

      function goBack() {
        console.log("뒤로가기");
        history.back();
      }

      function openDemo(page) {
        if (!selectedAvailable) {
          alert("현재 사용중인 로봇입니다. 다른 로봇을 선택해주세요.");
        } else {
          if (selectedRobot && selectedTop && selectedLeft) {
            const url =
              page +
              `.html?robot=${selectedRobot}&top=${selectedTop}&left=${selectedLeft}`;
            window.location.href = url;
          } else {
            alert("로봇을 선택해주세요");
          }
        }
      }
    </script>
  </body>
</html>
